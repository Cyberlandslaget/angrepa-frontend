import NewExploitHeader from './NewExploitHeader';
import FileEditor from './FileHandling/FileEditor';
import { useEffect, useMemo } from 'react';
import useFiles from 'utils/useFiles';
import { useLocation } from 'react-router-dom';
import { File } from 'utils/types';
import { DEFAULT_CONFIG_JSON } from 'utils/constants';

export default function NewExploit() {
  const { currentFiles, setFiles, setSelectedFile } = useFiles();
  const location = useLocation();
  const locationStateFiles = useMemo(
    () => (location?.state as { files: File[] | null })?.files,
    [location]
  );

  useEffect(() => {
    if (locationStateFiles) setFiles(locationStateFiles);
    else {
      const files = [DEFAULT_CONFIG_JSON()];
      const sameFile =
        files.length === currentFiles.length &&
        JSON.stringify(files[0]) === JSON.stringify(currentFiles[0]);
      setFiles(sameFile ? currentFiles : files);
    }
    setSelectedFile('config.json');
  }, [location?.state?.files]);

  return (
    <div className="w-full h-full grid grid-flow-row [grid-template-rows:6.5rem_1fr] gap-3">
      <NewExploitHeader />
      <FileEditor />
    </div>
  );
}
