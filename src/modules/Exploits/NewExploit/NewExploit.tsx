import NewExploitHeader from './NewExploitHeader';
import FileEditor from './FileHandling/FileEditor';
import { useEffect, useMemo } from 'react';
import useFiles from 'utils/useFiles';
import { useLocation } from 'react-router-dom';
import { File } from 'utils/types';

export default function NewExploit() {
  const { currentFiles, setFiles } = useFiles();
  const textEncoder = useMemo(() => new TextEncoder(), []);
  const location = useLocation();

  useEffect(() => {
    if (location?.state?.files) setFiles(location.state.files);
    else {
      const files = [
        {
          name: 'config.json',
          data: textEncoder.encode(`{
  "service": "testservice",
  "blacklist": ["10.1.1.2", "10.1.1.3"]
}`),
        },
      ] as File[];
      const sameFile =
        files.length === currentFiles.length &&
        JSON.stringify(files[0]) === JSON.stringify(currentFiles[0]);
      setFiles(sameFile ? currentFiles : files);
    }
  }, [location?.state?.files, setFiles, currentFiles, textEncoder]);

  return (
    <div className="w-full h-full grid grid-flow-row [grid-template-rows:6.5rem_1fr] gap-3">
      <NewExploitHeader />
      <FileEditor />
    </div>
  );
}
